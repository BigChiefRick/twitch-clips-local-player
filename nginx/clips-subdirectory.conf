# Twitch Clips Player - Subdirectory Configuration
# Add this inside your existing server { } block in /etc/nginx/sites-enabled/default
# Place it BEFORE the "location / {" block

# ============================================
# TWITCH CLIPS PLAYER (/clips/)
# ============================================

# Serve the player frontend at /clips/
location = /clips {
    return 301 /clips/;
}

location = /clips/ {
    alias /var/www/html/twitch-clips-player/;
    try_files /index.html =404;
}

# Serve static assets for the player
location /clips/assets/ {
    alias /var/www/html/twitch-clips-player/assets/;
}

# API proxy to Node.js backend
location /clips/api/ {
    proxy_pass http://127.0.0.1:3001/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
}

# Serve downloaded video clips
location /clips/videos/ {
    alias /var/www/html/twitch-clips-player/downloaded_clips/;

    # CORS headers for video playback
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'Range, Content-Type' always;

    # Caching
    add_header Cache-Control "public, max-age=3600";

    # Security
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;

    # Video file handling with range requests
    location ~* \.(mp4|webm|ogg)$ {
        add_header Accept-Ranges bytes always;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Range, Content-Type' always;
        add_header Cache-Control "public, max-age=3600";
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options SAMEORIGIN always;
    }

    # Handle OPTIONS preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Range, Content-Type' always;
        add_header Access-Control-Max-Age 86400;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}

# Optional: Rate limiting for API (uncomment to enable)
# location /clips/api/popular-clips/ {
#     limit_req zone=clips_api burst=5 nodelay;
#     proxy_pass http://127.0.0.1:3001/popular-clips/;
# }
